# .github/workflows/football_data_collection.yml
name: Football Big 5 Data Collection

# D√©clenchement tous les lundis √† 6h00 UTC
on:
  schedule:
    - cron: '0 6 * * 1'  # Tous les lundis √† 6h00 UTC
  workflow_dispatch:  # Permet de lancer manuellement le workflow

jobs:
  collect-data:
    runs-on: ubuntu-latest
    
    steps:
    # √âtape 1: Checkout du code
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # √âtape 2: Configuration de Python
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    # √âtape 3: Installation des d√©pendances
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas
    
    # √âtape 4: Cr√©ation du dossier data
    - name: Create data directory
      run: mkdir -p data
    
    # √âtape 5: Ex√©cution du script de collecte
    - name: Run football data collection
      env:
        RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
      run: |
        # Modification du script pour utiliser la variable d'environnement
        python -c "
        import os
        import sys
        
        # Import du script principal
        exec(open('football_data_collector.py').read().replace(
            'RAPIDAPI_KEY = \"YOUR_RAPIDAPI_KEY\"',
            'RAPIDAPI_KEY = os.environ.get(\"RAPIDAPI_KEY\")'
        ))
        "
    
    # √âtape 6: Commit et push des nouveaux fichiers CSV
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/*.csv
        git add football_data.log
        
        # V√©rifier s'il y a des changements √† committer
        if git diff --staged --quiet; then
          echo "Aucun changement √† committer"
        else
          git commit -m "üîÑ Mise √† jour automatique des donn√©es Big 5 - $(date '+%Y-%m-%d')"
          git push
        fi
    
    # √âtape 7: Upload des logs en cas d'erreur
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: football-data-logs
        path: football_data.log
    
    # √âtape 8: R√©sum√© des fichiers g√©n√©r√©s
    - name: Display summary
      run: |
        echo "=== R√âSUM√â DE LA COLLECTE ==="
        echo "Date: $(date)"
        echo "Fichiers g√©n√©r√©s:"
        ls -la data/
        echo ""
        echo "Taille des fichiers:"
        du -h data/*.csv 2>/dev/null || echo "Aucun fichier CSV trouv√©"
        echo ""
        echo "Derni√®res lignes du log:"
        tail -10 football_data.log 2>/dev/null || echo "Aucun log trouv√©"
