name: Football Odds Update - Fixed

on:
  schedule:
    - cron: '0 2 * * *' # Run daily at 2 AM UTC
  workflow_dispatch:

jobs:
  update-odds:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    permissions:
      contents: write
      actions: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy

    # CORRECTION: Test API amÃ©liorÃ© avec gestion d'erreurs
    - name: Test API Availability
      env:
        RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
      run: |
        echo "ğŸ” Test de l'API RapidAPI..."
        
        # VÃ©rifier que la clÃ© API existe
        if [ -z "$RAPIDAPI_KEY" ]; then
          echo "âŒ RAPIDAPI_KEY manquante!"
          exit 1
        fi
        
        echo "ğŸ”‘ ClÃ© API: ${RAPIDAPI_KEY:0:10}... (${#RAPIDAPI_KEY} caractÃ¨res)"
        
        # Test avec Python pour meilleur contrÃ´le
        python3 << 'EOF'
import requests
import os
import sys

headers = {
    'X-RapidAPI-Key': os.environ.get('RAPIDAPI_KEY'),
    'X-RapidAPI-Host': 'api-football-v1.p.rapidapi.com'
}

try:
    print("ğŸ“¡ Test connexion API...")
    response = requests.get(
        'https://api-football-v1.p.rapidapi.com/v3/status',
        headers=headers,
        timeout=15
    )
    
    print(f"ğŸ“Š Status code: {response.status_code}")
    
    if response.status_code == 200:
        data = response.json()
        print("âœ… API disponible!")
        print(f"ğŸ“ˆ Plan: {data.get('subscription', {}).get('plan', 'N/A')}")
        
        # VÃ©rifier les quotas
        remaining = data.get('subscription', {}).get('requests_remaining')
        if remaining is not None:
            print(f"ğŸ”¢ RequÃªtes restantes: {remaining}")
            if int(remaining) < 50:
                print("âš ï¸ Attention: Peu de requÃªtes restantes!")
        
    elif response.status_code == 403:
        print("âŒ Erreur 403: ClÃ© API invalide ou quota Ã©puisÃ©")
        print(f"ğŸ“ RÃ©ponse: {response.text}")
        sys.exit(1)
    elif response.status_code == 404:
        print("âŒ Erreur 404: Endpoint non trouvÃ©")
        print("ğŸ”§ VÃ©rification de l'URL et des headers...")
        print(f"ğŸ“ Headers envoyÃ©s: {headers}")
        sys.exit(1)
    else:
        print(f"âŒ Erreur API: {response.status_code}")
        print(f"ğŸ“ RÃ©ponse: {response.text[:300]}")
        sys.exit(1)
        
except requests.exceptions.Timeout:
    print("â° Timeout lors de la connexion Ã  l'API")
    sys.exit(1)
except requests.exceptions.ConnectionError as e:
    print(f"ğŸ”Œ Erreur de connexion: {e}")
    sys.exit(1)
except Exception as e:
    print(f"âŒ Erreur inattendue: {e}")
    sys.exit(1)
EOF

    # AJOUT: VÃ©rification des fichiers nÃ©cessaires
    - name: Check Required Files
      run: |
        echo "ğŸ“‚ VÃ©rification des fichiers requis..."
        
        if [ ! -f "football_odds_updater.py" ]; then
          echo "âŒ Script football_odds_updater.py manquant!"
          echo "ğŸ“‹ Fichiers Python disponibles:"
          ls -la *.py || echo "Aucun fichier Python trouvÃ©"
          exit 1
        fi
        
        echo "âœ… Script football_odds_updater.py trouvÃ©"
        
        # VÃ©rifier la structure des dossiers
        echo "ğŸ“ Structure des donnÃ©es:"
        if [ -d "data" ]; then
          echo "  âœ… Dossier data/ existe"
          if [ -d "data/matches" ]; then
            match_files=$(ls data/matches/*.csv 2>/dev/null | wc -l)
            echo "  ğŸ“Š Fichiers de matchs: $match_files"
          else
            echo "  âš ï¸ Dossier data/matches/ manquant"
          fi
          
          if [ -d "data/odds" ]; then
            echo "  âœ… Dossier data/odds/ existe"
          else
            echo "  â„¹ï¸ Dossier data/odds/ sera crÃ©Ã©"
          fi
        else
          echo "  âŒ Dossier data/ manquant - crÃ©ation nÃ©cessaire"
          mkdir -p data/odds/raw_data
          echo "  âœ… Structure crÃ©Ã©e"
        fi

    - name: Run Odds Updater Script
      env:
        RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
      run: |
        echo "ğŸš€ DÃ‰BUT DE LA MISE Ã€ JOUR DES COTES: $(date)"
        
        # CrÃ©er les dossiers nÃ©cessaires
        mkdir -p data/odds/raw_data
        mkdir -p data/matches
        
        # ExÃ©cution avec gestion d'erreurs amÃ©liorÃ©e
        if python3 football_odds_updater.py 2>&1 | tee odds_update.log; then
          echo "âœ… Script de mise Ã  jour exÃ©cutÃ© avec succÃ¨s."
        else
          exit_code=$?
          echo "âŒ Le script de mise Ã  jour a Ã©chouÃ© avec le code: $exit_code"
          echo ""
          echo "=== ANALYSE DE L'ERREUR ==="
          
          if [ -f "odds_update.log" ]; then
            echo "ğŸ“‹ DerniÃ¨res lignes du log:"
            tail -30 odds_update.log
            echo ""
            
            echo "ğŸ” Erreurs dÃ©tectÃ©es:"
            grep -i "error\|exception\|traceback" odds_update.log || echo "Aucune erreur Python dÃ©tectÃ©e"
            echo ""
            
            echo "âš ï¸ Avertissements:"
            grep -i "warning" odds_update.log || echo "Aucun avertissement"
          else
            echo "âŒ Fichier de log non crÃ©Ã©"
          fi
          
          exit $exit_code
        fi
        
        echo "ğŸ FIN DE LA MISE Ã€ JOUR: $(date)"

    # AJOUT: Analyse des rÃ©sultats avant commit
    - name: Analyze Update Results
      run: |
        echo "=== ANALYSE DES RÃ‰SULTATS ==="
        
        # VÃ©rifier les changements
        echo "ğŸ“Š Changements dÃ©tectÃ©s:"
        git status --porcelain || echo "Aucun changement"
        echo ""
        
        # Analyser les fichiers de cotes
        if [ -d "data/odds/raw_data" ]; then
          echo "ğŸ“ˆ Fichiers de cotes:"
          csv_count=0
          total_lines=0
          
          for file in data/odds/raw_data/*.csv; do
            if [ -f "$file" ]; then
              csv_count=$((csv_count + 1))
              lines=$(wc -l < "$file" 2>/dev/null || echo "0")
              size=$(du -h "$file" 2>/dev/null | cut -f1 || echo "?")
              echo "  ğŸ“‹ $(basename "$file"): $((lines-1)) cotes, $size"
              total_lines=$((total_lines + lines - 1))
            fi
          done
          
          echo ""
          echo "ğŸ“Š RÃ©sumÃ©: $csv_count fichiers, $total_lines cotes totales"
        else
          echo "âŒ Dossier data/odds/raw_data non trouvÃ©"
        fi
        
        # Analyser les logs
        if [ -f "odds_update.log" ]; then
          echo ""
          echo "ğŸ“‹ Statistiques du log:"
          echo "  ğŸ”¢ Lignes totales: $(wc -l < odds_update.log)"
          
          api_calls=$(grep -c "Appel API" odds_update.log || echo "0")
          echo "  ğŸ“ Appels API: $api_calls"
          
          errors=$(grep -c -i "erreur\|error" odds_update.log || echo "0")
          echo "  âŒ Erreurs: $errors"
          
          if [ "$errors" -gt 0 ]; then
            echo ""
            echo "ğŸ” DerniÃ¨res erreurs:"
            grep -i "erreur\|error" odds_update.log | tail -5 || echo "Aucune erreur trouvÃ©e"
          fi
        fi

    - name: Commit and Push Changes
      run: |
        git config user.name "GitHub Action"
        git config user.email "action@github.com"

        # VÃ©rifier s'il y a des changements
        if [ -z "$(git status --porcelain)" ]; then
          echo "â„¹ï¸ Aucune nouvelle donnÃ©e Ã  committer."
          exit 0
        fi

        echo "ğŸ“Š Fichiers modifiÃ©s Ã  committer:"
        git status --porcelain

        # Ajouter les fichiers par catÃ©gorie avec vÃ©rification
        files_added=0
        
        # Logs
        if [ -f "odds_update.log" ]; then
          git add odds_update.log && files_added=$((files_added + 1))
          echo "âœ… Log ajoutÃ©"
        fi
        
        # DonnÃ©es odds avec contrÃ´le de taille
        if [ -d "data/odds" ]; then
          large_files=0
          for file in $(find data/odds -name "*.csv"); do
            if [ -f "$file" ]; then
              size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "0")
              if [ "$size" -gt 50000000 ]; then  # 50MB max
                large_files=$((large_files + 1))
                echo "âš ï¸ Fichier volumineux ignorÃ©: $(basename "$file") ($((size / 1024 / 1024))MB)"
              else
                git add "$file" && files_added=$((files_added + 1))
                echo "âœ… Fichier ajoutÃ©: $(basename "$file")"
              fi
            fi
          done
          
          if [ "$large_files" -gt 0 ]; then
            echo "ğŸ“Š $large_files fichiers ignorÃ©s (trop volumineux)"
          fi
        fi
        
        echo "ğŸ“ˆ Total fichiers ajoutÃ©s: $files_added"

        # CrÃ©er le commit si des fichiers ont Ã©tÃ© ajoutÃ©s
        if ! git diff --staged --quiet; then
          commit_msg="ğŸ“Š Mise Ã  jour quotidienne des cotes - $(date '+%Y-%m-%d %H:%M')

ğŸ”„ Mise Ã  jour incrÃ©mentale (derniers 3 jours + 7 jours futurs)
ğŸ“ˆ Fichiers traitÃ©s: $files_added
ğŸ¤– Mise Ã  jour automatique via GitHub Actions"

          git commit -m "$commit_msg"

          # Retry push avec backoff
          for attempt in 1 2 3; do
            if git push; then
              echo "âœ… Push rÃ©ussi (tentative $attempt)."
              break
            else
              if [ $attempt -lt 3 ]; then
                wait_time=$((attempt * 10))
                echo "âš ï¸ Push Ã©chouÃ©, nouvelle tentative dans ${wait_time}s..."
                sleep $wait_time
              else
                echo "âŒ Push dÃ©finitivement Ã©chouÃ© aprÃ¨s 3 tentatives."
                exit 1
              fi
            fi
          done
        else
          echo "â„¹ï¸ Aucun changement Ã  committer aprÃ¨s vÃ©rification."
        fi

    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: odds-update-log-${{ github.run_number }}
        path: |
          *.log
          football_odds_updater.py
        retention-days: 15
        if-no-files-found: warn

    # AJOUT: Rapport final dÃ©taillÃ©
    - name: Final Report
      if: always()
      run: |
        echo "=== RAPPORT FINAL DE MISE Ã€ JOUR ==="
        echo "ğŸ•’ Date: $(date)"
        echo "ğŸƒ Run ID: ${{ github.run_id }}"
        echo "ğŸ“Š Status: ${{ job.status }}"
        echo ""
        
        # Statistiques des fichiers
        if [ -d "data/odds" ]; then
          echo "ğŸ’¾ DonnÃ©es odds:"
          total_size=$(du -sh data/odds 2>/dev/null | cut -f1 || echo "N/A")
          echo "  ğŸ“ Taille totale: $total_size"
          
          csv_files=$(find data/odds -name "*.csv" 2>/dev/null | wc -l)
          echo "  ğŸ“ˆ Fichiers CSV: $csv_files"
        fi
        
        # RÃ©sumÃ© du log
        if [ -f "odds_update.log" ]; then
          echo ""
          echo "ğŸ“‹ RÃ©sumÃ© de l'exÃ©cution:"
          
          # Extraire les statistiques finales du log
          if grep -q "=== MISE Ã€ JOUR TERMINÃ‰E ===" odds_update.log; then
            echo "âœ… Mise Ã  jour terminÃ©e normalement"
            
            # Extraire les stats si disponibles
            leagues_updated=$(grep "Ligues mises Ã  jour:" odds_update.log | tail -1 | cut -d: -f2 | xargs || echo "N/A")
            fixtures_processed=$(grep "Matchs traitÃ©s:" odds_update.log | tail -1 | cut -d: -f2 | xargs || echo "N/A")
            api_calls=$(grep "Appels API" odds_update.log | tail -1 | cut -d: -f2 | xargs || echo "N/A")
            
            echo "  ğŸ† Ligues mises Ã  jour: $leagues_updated"
            echo "  ğŸŸï¸ Matchs traitÃ©s: $fixtures_processed"
            echo "  ğŸ“ Appels API: $api_calls"
          else
            echo "âŒ Mise Ã  jour interrompue"
            
            # DerniÃ¨res lignes pour diagnostic
            echo ""
            echo "ğŸ” DerniÃ¨res lignes du log:"
            tail -10 odds_update.log || echo "Log non accessible"
          fi
        fi
        
        echo ""
        echo "ğŸ¯ Artefacts sauvegardÃ©s: odds-update-log-${{ github.run_number }}"
        echo ""
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ MISE Ã€ JOUR RÃ‰USSIE!"
        else
          echo "âŒ MISE Ã€ JOUR Ã‰CHOUÃ‰E - Consultez les logs"
        fi
